# https://helm.sh/docs/chart_template_guide/variables/
{{- $ReleaseName := .Release.Name -}}
{{- $ProviderName := .Values.providerConfig.name }}
{{- range $nodePool := .Values.additionalNodePools }}
---
apiVersion: containerservice.azure.upbound.io/v1beta1
kind: KubernetesClusterNodePool
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  labels:
    containerservice.azure.upbound.io/kubernetesCluster: {{ $nodePool.name }}
  name: {{ $nodePool.name }}
spec:
  forProvider:
    mode: {{ $nodePool.mode }}
    {{- if $nodePool.enableAutoScaling }}
    enableAutoScaling: true
    minCount: 1
    maxCount: 5
    {{- else }}
    nodeCount: 1
    {{- end }}
    vmSize: Standard_D4s_v3
    kubernetesClusterIdSelector:
      matchLabels:
        containerservice.azure.upbound.io/kubernetesCluster: {{ $ReleaseName }}
    nodeCount: {{ $nodePool.nodeCount }}
    vmSize: {{ $nodePool.vmSize }}
    vnetSubnetIdSelector: 
      matchLabels:
        network.azure.upbound.io/subnet: {{ $nodePool.subnet }}
  providerConfigRef:
    name: {{ $ProviderName }}

{{- end }}